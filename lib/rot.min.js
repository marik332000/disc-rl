var ROT={isSupported:function(){return !!(document.createElement("canvas").getContext&&Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{"4":[[0,-1],[1,0],[0,1],[-1,0]],"8":[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],"6":[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};ROT.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(g,e){var b={width:0,height:1};var f=this.tokenize(g,e);var a=0;for(var d=0;d<f.length;d++){var c=f[d];switch(c.type){case this.TYPE_TEXT:a+=c.value.length;break;case this.TYPE_NEWLINE:b.height++;b.width=Math.max(b.width,a);a=0;break}}b.width=Math.max(b.width,a);return b},tokenize:function(e,c){var a=[];var d=0;e.replace(this.RE_COLORS,function(i,j,h,g){var f=e.substring(d,g);if(f.length){a.push({type:ROT.Text.TYPE_TEXT,value:f})}a.push({type:(j=="c"?ROT.Text.TYPE_FG:ROT.Text.TYPE_BG),value:h.trim()});d=g+i.length;return""});var b=e.substring(d);if(b.length){a.push({type:ROT.Text.TYPE_TEXT,value:b})}return this._breakLines(a,c)},_breakLines:function(k,l){if(!l){l=Infinity}var e=0;var a=0;var h=-1;while(e<k.length){var d=k[e];if(d.type==ROT.Text.TYPE_NEWLINE){a=0;h=-1}if(d.type!=ROT.Text.TYPE_TEXT){e++;continue}while(a==0&&d.value.charAt(0)==" "){d.value=d.value.substring(1)}var j=d.value.indexOf("\n");if(j!=-1){d.value=this._breakInsideToken(k,e,j,true);var g=d.value.split("");while(g[g.length-1]==" "){g.pop()}d.value=g.join("")}if(!d.value.length){k.splice(e,1);continue}if(a+d.value.length>l){var j=-1;while(1){var f=d.value.indexOf(" ",j+1);if(f==-1){break}if(a+f>l){break}j=f}if(j!=-1){d.value=this._breakInsideToken(k,e,j,true)}else{if(h!=-1){var d=k[h];var c=d.value.lastIndexOf(" ");d.value=this._breakInsideToken(k,h,c,true);e=h}else{d.value=this._breakInsideToken(k,e,l-a,false)}}}else{a+=d.value.length;if(d.value.indexOf(" ")!=-1){h=e}}e++}k.push({type:ROT.Text.TYPE_NEWLINE});var b=null;for(var e=0;e<k.length;e++){var d=k[e];switch(d.type){case ROT.Text.TYPE_TEXT:b=d;break;case ROT.Text.TYPE_NEWLINE:if(b){var g=b.value.split("");while(g[g.length-1]==" "){g.pop()}b.value=g.join("")}b=null;break}}k.pop();return k},_breakInsideToken:function(e,a,f,d){var c={type:ROT.Text.TYPE_NEWLINE};var b={type:ROT.Text.TYPE_TEXT,value:e[a].value.substring(f+(d?1:0))};e.splice(a+1,0,c,b);return e[a].value.substring(0,f)}};ROT.Scheduler=function(){this._items=[]};ROT.Scheduler.prototype.add=function(a){var b={item:a,bucket:1/a.getSpeed()};this._items.push(b);return this};ROT.Scheduler.prototype.clear=function(){this._items=[];return this};ROT.Scheduler.prototype.remove=function(c){var b=null;for(var a=0;a<this._items.length;a++){b=this._items[a];if(b.item==c){this._items.splice(a,1);break}}return this};ROT.Scheduler.prototype.next=function(){if(!this._items.length){return null}var c=Infinity;var d=null;for(var a=0;a<this._items.length;a++){var b=this._items[a];if(b.bucket<c){c=b.bucket;d=b}else{if(b.bucket==c&&b.item.getSpeed()>d.item.getSpeed()){d=b}}}if(c){for(var a=0;a<this._items.length;a++){var b=this._items[a];b.bucket=Math.max(0,b.bucket-c)}}d.bucket+=1/d.item.getSpeed();return d.item};ROT.Engine=function(){this._scheduler=new ROT.Scheduler();this._lock=1};ROT.Engine.prototype.addActor=function(a){this._scheduler.add(a);return this};ROT.Engine.prototype.removeActor=function(a){this._scheduler.remove(a);return this};ROT.Engine.prototype.clear=function(){this._scheduler.clear();return this};ROT.Engine.prototype.start=function(){return this.unlock()};ROT.Engine.prototype.lock=function(){this._lock++};ROT.Engine.prototype.unlock=function(){if(!this._lock){throw new Error("Cannot unlock unlocked engine")}this._lock--;while(!this._lock){var a=this._scheduler.next();if(!a){return this.lock()}a.act()}return this};Array.prototype.random=function(){if(!this.length){return null}return this[Math.floor(ROT.RNG.getUniform()*this.length)]};Array.prototype.randomize=function(){var a=[];while(this.length){var b=this.indexOf(this.random());a.push(this.splice(b,1)[0])}return a};if(!Date.now){Date.now=function(){return +(new Date)}}Number.prototype.mod=function(a){return((this%a)+a)%a};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substring(1)};String.prototype.lpad=function(e,d){var c=e||"0";var a=d||2;var b="";while(b.length<(a-this.length)){b+=c}b=b.substring(0,a-this.length);return b+this};String.prototype.rpad=function(e,d){var c=e||"0";var a=d||2;var b="";while(b.length<(a-this.length)){b+=c}b=b.substring(0,a-this.length);return this+b};String.format=function(c){var d=String.format.map;var a=Array.prototype.slice.call(arguments,1);var b=function(l,h,f,m){if(c.charAt(m-1)=="%"){return l.substring(1)}if(!a.length){return l}var j=a[0];var n=h||f;var i=n.split(",");var g=i.shift();var e=d[g.toLowerCase()];if(!e){return l}var j=a.shift();var o=j[e].apply(j,i);var k=g.charAt(0);if(k!=k.toLowerCase()){o=o.capitalize()}return o};return c.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,b)};String.format.map={s:"toString"};String.prototype.format=function(){var a=Array.prototype.slice.call(arguments);a.unshift(this);return String.format.apply(String,a)};if(!Object.create){Object.create=function(b){var a=function(){};a.prototype=b;return new a()}}Function.prototype.extend=function(a){this.prototype=Object.create(a.prototype);this.prototype.constructor=this;return this};ROT.Display=function(c){var b=document.createElement("canvas");this._context=b.getContext("2d");this._data={};this._dirty=false;this._options={};this._backend=null;var a={width:ROT.DEFAULT_WIDTH,height:ROT.DEFAULT_HEIGHT,layout:"rect",fontSize:15,fps:25,spacing:1,border:0,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000"};for(var d in c){a[d]=c[d]}this.setOptions(a);this.DEBUG=this.DEBUG.bind(this);this._interval=setInterval(this._tick.bind(this),1000/this._options.fps)};ROT.Display.prototype.DEBUG=function(a,d,c){var b=[this._options.bg,this._options.fg];this.draw(a,d,null,null,b[c%b.length])};ROT.Display.prototype.clear=function(){this._data={};this._dirty=true};ROT.Display.prototype.setOptions=function(b){for(var c in b){this._options[c]=b[c]}if(b.width||b.height||b.fontSize||b.fontFamily||b.spacing||b.layout){if(b.layout){this._backend=new ROT.Display[b.layout.capitalize()](this._context)}var a=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=a;this._backend.compute(this._options);this._context.font=a;this._context.textAlign="center";this._context.textBaseline="middle";this._dirty=true}return this};ROT.Display.prototype.getOptions=function(){return this._options};ROT.Display.prototype.getContainer=function(){return this._context.canvas};ROT.Display.prototype.computeSize=function(b,a){return this._backend.computeSize(b,a,this._options)};ROT.Display.prototype.computeFontSize=function(b,a){return this._backend.computeFontSize(b,a,this._options)};ROT.Display.prototype.draw=function(a,e,d,b,c){if(!b){b=this._options.fg}if(!c){c=this._options.bg}this._data[a+","+e]=[a,e,d,b,c];if(this._dirty===true){return}if(!this._dirty){this._dirty={}}this._dirty[a+","+e]=true};ROT.Display.prototype.drawText=function(j,h,l,k){var a=null;var f=null;var d=j;var c=h;var m=1;if(!k){k=this._options.width-j}var g=ROT.Text.tokenize(l,k);while(g.length){var b=g.shift();switch(b.type){case ROT.Text.TYPE_TEXT:for(var e=0;e<b.value.length;e++){this.draw(d++,c,b.value.charAt(e),a,f)}break;case ROT.Text.TYPE_FG:a=b.value||null;break;case ROT.Text.TYPE_BG:f=b.value||null;break;case ROT.Text.TYPE_NEWLINE:d=j;c++;m++;break}}return m};ROT.Display.prototype._tick=function(){if(!this._dirty){return}if(this._dirty===true){this._context.fillStyle=this._options.bg;this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var b in this._data){this._draw(b,false)}}else{for(var a in this._dirty){this._draw(a,true)}}this._dirty=false};ROT.Display.prototype._draw=function(b,a){var c=this._data[b];if(c[4]!=this._options.bg){a=true}this._backend.draw(c,a)};ROT.Display.Backend=function(a){this._context=a};ROT.Display.Backend.prototype.compute=function(a){};ROT.Display.Backend.prototype.draw=function(b,a){};ROT.Display.Backend.prototype.computeSize=function(b,a){};ROT.Display.Backend.prototype.computeFontSize=function(b,a){};ROT.Display.Rect=function(a){ROT.Display.Backend.call(this,a);this._spacingX=0;this._spacingY=0;this._canvasCache={};this._options={}};ROT.Display.Rect.extend(ROT.Display.Backend);ROT.Display.Rect.cache=false;ROT.Display.Rect.prototype.compute=function(b){this._canvasCache={};this._options=b;var a=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(b.spacing*a);this._spacingY=Math.ceil(b.spacing*b.fontSize);this._context.canvas.width=b.width*this._spacingX;this._context.canvas.height=b.height*this._spacingY};ROT.Display.Rect.prototype.draw=function(b,a){if(this.constructor.cache){this._drawWithCache(b,a)}else{this._drawNoCache(b,a)}};ROT.Display.Rect.prototype._drawWithCache=function(f,h){var k=f[0];var j=f[1];var a=f[2];var c=f[3];var g=f[4];var e=""+a+c+g;if(e in this._canvasCache){var d=this._canvasCache[e]}else{var i=this._options.border;var d=document.createElement("canvas");var l=d.getContext("2d");d.width=this._spacingX;d.height=this._spacingY;l.fillStyle=g;l.fillRect(i,i,d.width-i,d.height-i);if(a){l.fillStyle=c;l.font=this._context.font;l.textAlign="center";l.textBaseline="middle";l.fillText(a,this._spacingX/2,this._spacingY/2)}this._canvasCache[e]=d}this._context.drawImage(d,k*this._spacingX,j*this._spacingY)};ROT.Display.Rect.prototype._drawNoCache=function(h,e){var c=h[0];var i=h[1];var g=h[2];var d=h[3];var f=h[4];if(e){var a=this._options.border;this._context.fillStyle=f;this._context.fillRect(c*this._spacingX+a,i*this._spacingY+a,this._spacingX-a,this._spacingY-a)}if(!g){return}this._context.fillStyle=d;this._context.fillText(g,(c+0.5)*this._spacingX,(i+0.5)*this._spacingY)};ROT.Display.Rect.prototype.computeSize=function(d,b){var c=Math.floor(d/this._spacingX);var a=Math.floor(b/this._spacingY);return[c,a]};ROT.Display.Rect.prototype.computeFontSize=function(h,b){var f=Math.floor(h/this._options.width);var g=Math.floor(b/this._options.height);var c=this._context.font;this._context.font="100px "+this._options.fontFamily;var e=Math.ceil(this._context.measureText("W").width);this._context.font=c;var d=e/100;var a=d*g/f;if(a>1){g=Math.floor(g/a)}return Math.floor(g/this._options.spacing)};ROT.Display.Hex=function(a){ROT.Display.Backend.call(this,a);this._spacingX=0;this._spacingY=0;this._hexSize=0;this._options={}};ROT.Display.Hex.extend(ROT.Display.Backend);ROT.Display.Hex.prototype.compute=function(b){this._options=b;var a=Math.ceil(this._context.measureText("W").width);this._hexSize=Math.floor(b.spacing*(b.fontSize+a/Math.sqrt(3))/2);this._spacingX=this._hexSize*Math.sqrt(3)/2;this._spacingY=this._hexSize*1.5;this._context.canvas.width=Math.ceil((b.width+1)*this._spacingX);this._context.canvas.height=Math.ceil((b.height-1)*this._spacingY+2*this._hexSize)};ROT.Display.Hex.prototype.draw=function(e,g){var i=e[0];var h=e[1];var a=e[2];var b=e[3];var f=e[4];var d=(i+1)*this._spacingX;var c=h*this._spacingY+this._hexSize;if(g){this._context.fillStyle=f;this._fill(d,c)}if(!a){return}this._context.fillStyle=b;this._context.fillText(a,d,c)};ROT.Display.Hex.prototype.computeSize=function(d,b){var c=Math.floor(d/this._spacingX)-1;var a=Math.floor((b-2*this._hexSize)/this._spacingY+1);return[c,a]};ROT.Display.Hex.prototype.computeFontSize=function(d,g){var h=2*d/((this._options.width+1)*Math.sqrt(3))-1;var e=g/(2+1.5*(this._options.height-1));var c=Math.min(h,e);var b=this._context.font;this._context.font="100px "+this._options.fontFamily;var a=Math.ceil(this._context.measureText("W").width);this._context.font=b;var f=a/100;c=Math.floor(c)+1;var i=2*c/(this._options.spacing*(1+f/Math.sqrt(3)));return Math.ceil(i)-1};ROT.Display.Hex.prototype._fill=function(d,f){var e=this._hexSize;var c=this._options.border;this._context.beginPath();this._context.moveTo(d,f-e+c);this._context.lineTo(d+this._spacingX-c,f-e/2+c);this._context.lineTo(d+this._spacingX-c,f+e/2-c);this._context.lineTo(d,f+e-c);this._context.lineTo(d-this._spacingX+c,f+e/2-c);this._context.lineTo(d-this._spacingX+c,f-e/2+c);this._context.lineTo(d,f-e+c);this._context.fill()};ROT.RNG={getSeed:function(){return this._seed},setSeed:function(a){a=(a<1?1/a:a);this._seed=a;this._s0=(a>>>0)*this._frac;a=(a*69069+1)>>>0;this._s1=a*this._frac;a=(a*69069+1)>>>0;this._s2=a*this._frac;this._c=1;return this},getUniform:function(){var a=2091639*this._s0+this._c*this._frac;this._s0=this._s1;this._s1=this._s2;this._c=a|0;this._s2=a-this._c;return this._s2},getNormal:function(a,f){do{var c=2*this.getUniform()-1;var b=2*this.getUniform()-1;var e=c*c+b*b}while(e>1||e==0);var d=c*Math.sqrt(-2*Math.log(e)/e);return(a||0)+d*(f||1)},getPercentage:function(){return 1+Math.floor(this.getUniform()*100)},getWeightedValue:function(e){var d=[];var c=0;for(var f in e){c+=e[f]}var b=Math.floor(this.getUniform()*c);var a=0;for(var f in e){a+=e[f];if(b<a){return f}}return null},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(a){this._s0=a[0];this._s1=a[1];this._s2=a[2];this._c=a[3];return this},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10};ROT.RNG.setSeed(Date.now());ROT.StringGenerator=function(a){this._options={words:false,order:3,prior:0.001};for(var c in a){this._options[c]=a[c]}this._boundary=String.fromCharCode(0);this._suffix=this._boundary;this._prefix=[];for(var b=0;b<this._options.order;b++){this._prefix.push(this._boundary)}this._priorValues={};this._priorValues[this._boundary]=this._options.prior;this._data={}};ROT.StringGenerator.prototype.clear=function(){this._data={};this._priorValues={}};ROT.StringGenerator.prototype.generate=function(){var a=[this._sample(this._prefix)];while(a[a.length-1]!=this._boundary){a.push(this._sample(a))}return this._join(a.slice(0,-1))};ROT.StringGenerator.prototype.observe=function(c){var g=this._split(c);for(var e=0;e<g.length;e++){this._priorValues[g[e]]=this._options.prior}g=this._prefix.concat(g).concat(this._suffix);for(var e=this._options.order;e<g.length;e++){var d=g.slice(e-this._options.order,e);var f=g[e];for(var b=0;b<d.length;b++){var a=d.slice(b);this._observeEvent(a,f)}}};ROT.StringGenerator.prototype.getStats=function(){var f=[];var a=0;for(var e in this._priorValues){a++}a--;f.push("distinct samples: "+a);var c=0;var d=0;for(var e in this._data){c++;for(var b in this._data[e]){d++}}f.push("dictionary size (contexts): "+c);f.push("dictionary size (events): "+d);return f.join(", ")};ROT.StringGenerator.prototype._split=function(a){return a.split(this._options.words?/\s+/:"")};ROT.StringGenerator.prototype._join=function(a){return a.join(this._options.words?" ":"")};ROT.StringGenerator.prototype._observeEvent=function(b,c){var a=this._join(b);if(!(a in this._data)){this._data[a]={}}var d=this._data[a];if(!(c in d)){d[c]=0}d[c]++};ROT.StringGenerator.prototype._sample=function(b){b=this._backoff(b);var a=this._join(b);var e=this._data[a];var d={};if(this._options.prior){for(var c in this._priorValues){d[c]=this._priorValues[c]}for(var c in e){d[c]+=e[c]}}else{d=e}return this._pickRandom(d)};ROT.StringGenerator.prototype._backoff=function(a){if(a.length>this._options.order){a=a.slice(-this._options.order)}else{if(a.length<this._options.order){a=this._prefix.slice(0,this._options.order-a.length).concat(a)}}while(!(this._join(a) in this._data)&&a.length>0){a=a.slice(1)}return a};ROT.StringGenerator.prototype._pickRandom=function(d){var c=0;for(var e in d){c+=d[e]}var b=ROT.RNG.getUniform()*c;var a=0;for(var e in d){a+=d[e];if(b<a){return e}}};ROT.Map=function(b,a){this._width=b||ROT.DEFAULT_WIDTH;this._height=a||ROT.DEFAULT_HEIGHT};ROT.Map.prototype.create=function(a){};ROT.Map.prototype._fillMap=function(c){var d=[];for(var b=0;b<this._width;b++){d.push([]);for(var a=0;a<this._height;a++){d[b].push(c)}}return d};ROT.Map.Arena=function(b,a){ROT.Map.call(this,b,a)};ROT.Map.Arena.extend(ROT.Map);ROT.Map.Arena.prototype.create=function(f){var a=this._width-1;var d=this._height-1;for(var c=0;c<=a;c++){for(var b=0;b<=d;b++){var e=(c&&b&&c<a&&b<d);f(c,b,e?0:1)}}return this};ROT.Map.DividedMaze=function(b,a){ROT.Map.call(this,b,a);this._stack=[]};ROT.Map.DividedMaze.extend(ROT.Map);ROT.Map.DividedMaze.prototype.create=function(f){var a=this._width;var e=this._height;this._map=[];for(var d=0;d<a;d++){this._map.push([]);for(var c=0;c<e;c++){var b=(d==0||c==0||d+1==a||c+1==e);this._map[d].push(b?1:0)}}this._stack=[[1,1,a-2,e-2]];this._process();for(var d=0;d<a;d++){for(var c=0;c<e;c++){f(d,c,this._map[d][c])}}this._map=null;return this};ROT.Map.DividedMaze.prototype._process=function(){while(this._stack.length){var a=this._stack.shift();this._partitionRoom(a)}};ROT.Map.DividedMaze.prototype._partitionRoom=function(b){var l=[];var h=[];for(var g=b[0]+1;g<b[2];g++){var n=this._map[g][b[1]-1];var c=this._map[g][b[3]+1];if(n&&c&&!(g%2)){l.push(g)}}for(var f=b[1]+1;f<b[3];f++){var e=this._map[b[0]-1][f];var q=this._map[b[2]+1][f];if(e&&q&&!(f%2)){h.push(f)}}if(!l.length||!h.length){return}var o=l.random();var m=h.random();this._map[o][m]=1;var d=[];var p=[];d.push(p);for(var g=b[0];g<o;g++){this._map[g][m]=1;p.push([g,m])}var p=[];d.push(p);for(var g=o+1;g<=b[2];g++){this._map[g][m]=1;p.push([g,m])}var p=[];d.push(p);for(var f=b[1];f<m;f++){this._map[o][f]=1;p.push([o,f])}var p=[];d.push(p);for(var f=m+1;f<=b[3];f++){this._map[o][f]=1;p.push([o,f])}var k=d.random();for(var g=0;g<d.length;g++){var p=d[g];if(p==k){continue}var a=p.random();this._map[a[0]][a[1]]=0}this._stack.push([b[0],b[1],o-1,m-1]);this._stack.push([o+1,b[1],b[2],m-1]);this._stack.push([b[0],m+1,o-1,b[3]]);this._stack.push([o+1,m+1,b[2],b[3]])};ROT.Map.IceyMaze=function(b,a,c){ROT.Map.call(this,b,a);this._regularity=c||0};ROT.Map.IceyMaze.extend(ROT.Map);ROT.Map.IceyMaze.prototype.create=function(n){var c=this._width;var o=this._height;var b=this._fillMap(1);c-=(c%2?1:2);o-=(o%2?1:2);var e=0;var d=0;var m=0;var l=0;var g=0;var k=false;var a=[[0,0],[0,0],[0,0],[0,0]];do{e=1+2*Math.floor(ROT.RNG.getUniform()*(c-1)/2);d=1+2*Math.floor(ROT.RNG.getUniform()*(o-1)/2);if(!g){b[e][d]=0}if(!b[e][d]){this._randomize(a);do{if(Math.floor(ROT.RNG.getUniform()*(this._regularity+1))==0){this._randomize(a)}k=true;for(var h=0;h<4;h++){m=e+a[h][0]*2;l=d+a[h][1]*2;if(this._isFree(b,m,l,c,o)){b[m][l]=0;b[e+a[h][0]][d+a[h][1]]=0;e=m;d=l;k=false;g++;break}}}while(!k)}}while(g+1<c*o/4);for(var h=0;h<this._width;h++){for(var f=0;f<this._height;f++){n(h,f,b[h][f])}}this._map=null;return this};ROT.Map.IceyMaze.prototype._randomize=function(b){for(var a=0;a<4;a++){b[a][0]=0;b[a][1]=0}switch(Math.floor(ROT.RNG.getUniform()*4)){case 0:b[0][0]=-1;b[1][0]=1;b[2][1]=-1;b[3][1]=1;break;case 1:b[3][0]=-1;b[2][0]=1;b[1][1]=-1;b[0][1]=1;break;case 2:b[2][0]=-1;b[3][0]=1;b[0][1]=-1;b[1][1]=1;break;case 3:b[1][0]=-1;b[0][0]=1;b[3][1]=-1;b[2][1]=1;break}};ROT.Map.IceyMaze.prototype._isFree=function(d,b,e,c,a){if(b<1||e<1||b>=c||e>=a){return false}return d[b][e]};ROT.Map.EllerMaze=function(b,a){ROT.Map.call(this,b,a)};ROT.Map.EllerMaze.extend(ROT.Map);ROT.Map.EllerMaze.prototype.create=function(l){var a=this._fillMap(1);var k=Math.ceil((this._width-2)/2);var g=9/24;var e=[];var c=[];for(var d=0;d<k;d++){e.push(d);c.push(d)}e.push(k-1);for(var b=1;b+3<this._height;b+=2){for(var d=0;d<k;d++){var h=2*d+1;var f=b;a[h][f]=0;if(d!=e[d+1]&&ROT.RNG.getUniform()>g){this._addToList(d,e,c);a[h+1][f]=0}if(d!=e[d]&&ROT.RNG.getUniform()>g){this._removeFromList(d,e,c)}else{a[h][f+1]=0}}}for(var d=0;d<k;d++){var h=2*d+1;var f=b;a[h][f]=0;if(d!=e[d+1]&&(d==e[d]||ROT.RNG.getUniform()>g)){this._addToList(d,e,c);a[h+1][f]=0}this._removeFromList(d,e,c)}for(var d=0;d<this._width;d++){for(var b=0;b<this._height;b++){l(d,b,a[d][b])}}return this};ROT.Map.EllerMaze.prototype._removeFromList=function(b,a,c){c[a[b]]=c[b];a[c[b]]=a[b];c[b]=b;a[b]=b};ROT.Map.EllerMaze.prototype._addToList=function(b,a,c){c[a[b+1]]=c[b];a[c[b]]=a[b+1];c[b]=b+1;a[b+1]=b};ROT.Map.Cellular=function(c,a,b){ROT.Map.call(this,c,a);this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8};for(var d in b){this._options[d]=b[d]}this._dirs=ROT.DIRS[this._options.topology];this._map=this._fillMap(0)};ROT.Map.Cellular.extend(ROT.Map);ROT.Map.Cellular.prototype.randomize=function(c){for(var b=0;b<this._width;b++){for(var a=0;a<this._height;a++){this._map[b][a]=(ROT.RNG.getUniform()<c?1:0)}}return this};ROT.Map.Cellular.prototype.set=function(a,c,b){this._map[a][c]=b};ROT.Map.Cellular.prototype.create=function(l){var a=this._fillMap(0);var c=this._options.born;var b=this._options.survive;for(var f=0;f<this._height;f++){var k=1;var d=0;if(this._options.topology==6){k=2;d=f%2}for(var g=d;g<this._width;g+=k){var h=this._map[g][f];var e=this._getNeighbors(g,f);if(h&&b.indexOf(e)!=-1){a[g][f]=1}else{if(!h&&c.indexOf(e)!=-1){a[g][f]=1}}if(l){l(g,f,a[g][f])}}}this._map=a};ROT.Map.Cellular.prototype._getNeighbors=function(c,g){var b=0;for(var e=0;e<this._dirs.length;e++){var d=this._dirs[e];var a=c+d[0];var f=g+d[1];if(a<0||a>=this._width||a<0||f>=this._width){continue}b+=(this._map[a][f]==1?1:0)}return b};ROT.Map.Dungeon=function(b,a){ROT.Map.call(this,b,a);this._rooms=[];this._corridors=[]};ROT.Map.Dungeon.extend(ROT.Map);ROT.Map.Dungeon.prototype.getRooms=function(){return this._rooms};ROT.Map.Dungeon.prototype.getCorridors=function(){return this._corridors};ROT.Map.Digger=function(c,a,b){ROT.Map.Dungeon.call(this,c,a);this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:0.2,timeLimit:1000};for(var d in b){this._options[d]=b[d]}this._features={Room:4,Corridor:4};this._featureAttempts=20;this._walls={};this._digCallback=this._digCallback.bind(this);this._canBeDugCallback=this._canBeDugCallback.bind(this);this._isWallCallback=this._isWallCallback.bind(this);this._priorityWallCallback=this._priorityWallCallback.bind(this)};ROT.Map.Digger.extend(ROT.Map.Dungeon);ROT.Map.Digger.prototype.create=function(p){this._rooms=[];this._corridors=[];this._map=this._fillMap(1);this._walls={};this._dug=0;var b=(this._width-2)*(this._height-2);this._firstRoom();var l=Date.now();do{var k=Date.now();if(k-l>this._options.timeLimit){break}var n=this._findWall();if(!n){break}var f=n.split(",");var o=parseInt(f[0]);var m=parseInt(f[1]);var d=this._getDiggingDirection(o,m);if(!d){continue}var h=0;do{h++;if(this._tryFeature(o,m,d[0],d[1])){if(this._rooms.length+this._corridors.length==2){this._rooms[0].addDoor(o,m)}this._removeSurroundingWalls(o,m);this._removeSurroundingWalls(o-d[0],m-d[1]);break}}while(h<this._featureAttempts);var c=0;for(var a in this._walls){if(this._walls[a]>1){c++}}}while(this._dug/b<this._options.dugPercentage||c);if(p){for(var g=0;g<this._width;g++){for(var e=0;e<this._height;e++){p(g,e,this._map[g][e])}}}this._walls={};this._map=null;return this};ROT.Map.Digger.prototype._digCallback=function(a,c,b){if(b==0||b==2){this._map[a][c]=0;this._dug++}else{this._walls[a+","+c]=1}};ROT.Map.Digger.prototype._isWallCallback=function(a,b){if(a<0||b<0||a>=this._width||b>=this._height){return false}return(this._map[a][b]==1)};ROT.Map.Digger.prototype._canBeDugCallback=function(a,b){if(a<1||b<1||a+1>=this._width||b+1>=this._height){return false}return(this._map[a][b]==1)};ROT.Map.Digger.prototype._priorityWallCallback=function(a,b){this._walls[a+","+b]=2};ROT.Map.Digger.prototype._firstRoom=function(){var a=Math.floor(this._width/2);var c=Math.floor(this._height/2);var b=ROT.Map.Feature.Room.createRandomCenter(a,c,this._options);this._rooms.push(b);b.create(this._digCallback)};ROT.Map.Digger.prototype._findWall=function(){var c=[];var b=[];for(var e in this._walls){var d=this._walls[e];if(d==2){b.push(e)}else{c.push(e)}}var a=(b.length?b:c);if(!a.length){return null}var e=a.random();delete this._walls[e];return e};ROT.Map.Digger.prototype._tryFeature=function(f,d,i,g){var h=null;var e=0;for(var b in this._features){e+=this._features[b]}var c=Math.floor(ROT.RNG.getUniform()*e);var a=0;for(var b in this._features){a+=this._features[b];if(c<a){h=ROT.Map.Feature[b];break}}h=h.createRandomAt(f,d,i,g,this._options);if(!h.isValid(this._isWallCallback,this._canBeDugCallback)){return false}h.create(this._digCallback);if(h instanceof ROT.Map.Feature.Room){this._rooms.push(h)}if(h instanceof ROT.Map.Feature.Corridor){h.createPriorityWalls(this._priorityWallCallback);this._corridors.push(h)}return true};ROT.Map.Digger.prototype._removeSurroundingWalls=function(b,g){var d=ROT.DIRS[4];for(var c=0;c<d.length;c++){var f=d[c];var a=b+f[0];var e=g+f[1];delete this._walls[a+","+e];var a=b+2*f[0];var e=g+2*f[1];delete this._walls[a+","+e]}};ROT.Map.Digger.prototype._getDiggingDirection=function(c,h){var b=null;var e=ROT.DIRS[4];for(var d=0;d<e.length;d++){var g=e[d];var a=c+g[0];var f=h+g[1];if(a<0||f<0||a>=this._width||f>=this._width){return null}if(!this._map[a][f]){if(b){return null}b=g}}if(!b){return null}return[-b[0],-b[1]]};ROT.Map.Uniform=function(c,a,b){ROT.Map.Dungeon.call(this,c,a);this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:0.1,timeLimit:1000};for(var d in b){this._options[d]=b[d]}this._roomAttempts=20;this._corridorAttempts=20;this._connected=[];this._unconnected=[];this._digCallback=this._digCallback.bind(this);this._canBeDugCallback=this._canBeDugCallback.bind(this);this._isWallCallback=this._isWallCallback.bind(this)};ROT.Map.Uniform.extend(ROT.Map.Dungeon);ROT.Map.Uniform.prototype.create=function(e){var d=Date.now();while(1){var c=Date.now();if(c-d>this._options.timeLimit){return null}this._map=this._fillMap(1);this._dug=0;this._rooms=[];this._unconnected=[];this._generateRooms();if(this._generateCorridors()){break}}if(e){for(var b=0;b<this._width;b++){for(var a=0;a<this._height;a++){e(b,a,this._map[b][a])}}}return this};ROT.Map.Uniform.prototype._generateRooms=function(){var a=this._width-2;var b=this._height-2;do{var c=this._generateRoom();if(this._dug/(a*b)>this._options.roomDugPercentage){break}}while(c)};ROT.Map.Uniform.prototype._generateRoom=function(){var a=0;while(a<this._roomAttempts){a++;var b=ROT.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(!b.isValid(this._isWallCallback,this._canBeDugCallback)){continue}b.create(this._digCallback);this._rooms.push(b);return b}return null};ROT.Map.Uniform.prototype._generateCorridors=function(){var c=0;while(c<this._corridorAttempts){c++;this._corridors=[];this._map=this._fillMap(1);for(var b=0;b<this._rooms.length;b++){var f=this._rooms[b];f.clearDoors();f.create(this._digCallback)}this._unconnected=this._rooms.slice().randomize();this._connected=[];if(this._unconnected.length){this._connected.push(this._unconnected.pop())}while(1){var d=this._connected.random();var g=this._closestRoom(this._unconnected,d);var e=this._closestRoom(this._connected,g);var a=this._connectRooms(g,e);if(!a){break}if(!this._unconnected.length){return true}}}return false};ROT.Map.Uniform.prototype._closestRoom=function(f,a){var k=Infinity;var e=a.getCenter();var n=null;for(var g=0;g<f.length;g++){var b=f[g];var j=b.getCenter();var m=j[0]-e[0];var l=j[1]-e[1];var h=m*m+l*l;if(h<k){k=h;n=b}}return n};ROT.Map.Uniform.prototype._connectRooms=function(j,i){var d=j.getCenter();var b=i.getCenter();var m=b[0]-d[0];var l=b[1]-d[1];if(Math.abs(m)<Math.abs(l)){var s=(l>0?2:0);var r=(s+2)%4;var p=i.getLeft();var q=i.getRight();var h=0}else{var s=(m>0?1:3);var r=(s+2)%4;var p=i.getTop();var q=i.getBottom();var h=1}var c=this._placeInWall(j,s);if(!c){return false}if(c[h]>=p&&c[h]<=q){var a=c.slice();var n=null;switch(r){case 0:n=i.getTop()-1;break;case 1:n=i.getRight()+1;break;case 2:n=i.getBottom()+1;break;case 3:n=i.getLeft()-1;break}a[(h+1)%2]=n;this._digLine([c,a])}else{if(c[h]<p-1||c[h]>q+1){var k=c[h]-b[h];switch(r){case 0:case 1:var o=(k<0?3:1);break;case 2:case 3:var o=(k<0?1:3);break}r=(r+o)%4;var a=this._placeInWall(i,r);if(!a){return false}var t=[0,0];t[h]=c[h];var e=(h+1)%2;t[e]=a[e];this._digLine([c,t,a])}else{var e=(h+1)%2;var a=this._placeInWall(i,r);if(!a){return}var t=Math.round((a[e]+c[e])/2);var g=[0,0];var f=[0,0];g[h]=c[h];g[e]=t;f[h]=a[h];f[e]=t;this._digLine([c,g,f,a])}}j.addDoor(c[0],c[1]);i.addDoor(a[0],a[1]);var h=this._unconnected.indexOf(j);if(h!=-1){this._unconnected.splice(h,1);this._connected.push(j)}var h=this._unconnected.indexOf(i);if(h!=-1){this._unconnected.splice(h,1);this._connected.push(i)}return true};ROT.Map.Uniform.prototype._placeInWall=function(a,g){var b=[0,0];var d=[0,0];var c=0;switch(g){case 0:d=[1,0];b=[a.getLeft(),a.getTop()-1];c=a.getRight()-a.getLeft()+1;break;case 1:d=[0,1];b=[a.getRight()+1,a.getTop()];c=a.getBottom()-a.getTop()+1;break;case 2:d=[1,0];b=[a.getLeft(),a.getBottom()+1];c=a.getRight()-a.getLeft()+1;break;case 3:d=[0,1];b=[a.getLeft()-1,a.getTop()];c=a.getBottom()-a.getTop()+1;break}var j=[];var h=-2;for(var f=0;f<c;f++){var l=b[0]+f*d[0];var k=b[1]+f*d[1];j.push(null);var e=(this._map[l][k]==1);if(e){if(h!=f-1){j[f]=[l,k]}}else{h=f;if(f){j[f-1]=null}}}for(var f=j.length-1;f>=0;f--){if(!j[f]){j.splice(f,1)}}return(j.length?j.random():null)};ROT.Map.Uniform.prototype._digLine=function(c){for(var b=1;b<c.length;b++){var e=c[b-1];var a=c[b];var d=new ROT.Map.Feature.Corridor(e[0],e[1],a[0],a[1]);d.create(this._digCallback);this._corridors.push(d)}};ROT.Map.Uniform.prototype._digCallback=function(a,c,b){this._map[a][c]=b;if(b==0){this._dug++}};ROT.Map.Uniform.prototype._isWallCallback=function(a,b){if(a<0||b<0||a>=this._width||b>=this._height){return false}return(this._map[a][b]==1)};ROT.Map.Uniform.prototype._canBeDugCallback=function(a,b){if(a<1||b<1||a+1>=this._width||b+1>=this._height){return false}return(this._map[a][b]==1)};ROT.Map.Feature=function(){};ROT.Map.Feature.prototype.isValid=function(a){};ROT.Map.Feature.prototype.create=function(a){};ROT.Map.Feature.prototype.debug=function(){};ROT.Map.Feature.createRandomAt=function(a,e,c,b,d){};ROT.Map.Feature.Room=function(b,e,a,c,f,d){this._x1=b;this._y1=e;this._x2=a;this._y2=c;this._doors={};if(arguments.length>4){this.addDoor(f,d)}};ROT.Map.Feature.Room.extend(ROT.Map.Feature);ROT.Map.Feature.Room.createRandomAt=function(g,e,k,i,j){var c=j.roomWidth[0];var f=j.roomWidth[1];var b=c+Math.floor(ROT.RNG.getUniform()*(f-c+1));var c=j.roomHeight[0];var f=j.roomHeight[1];var h=c+Math.floor(ROT.RNG.getUniform()*(f-c+1));if(k==1){var d=e-Math.floor(ROT.RNG.getUniform()*h);return new this(g+1,d,g+b,d+h-1,g,e)}if(k==-1){var d=e-Math.floor(ROT.RNG.getUniform()*h);return new this(g-b,d,g-1,d+h-1,g,e)}if(i==1){var a=g-Math.floor(ROT.RNG.getUniform()*b);return new this(a,e+1,a+b-1,e+h,g,e)}if(i==-1){var a=g-Math.floor(ROT.RNG.getUniform()*b);return new this(a,e-h,a+b-1,e-1,g,e)}};ROT.Map.Feature.Room.createRandomCenter=function(e,d,k){var f=k.roomWidth[0];var h=k.roomWidth[1];var b=f+Math.floor(ROT.RNG.getUniform()*(h-f+1));var f=k.roomHeight[0];var h=k.roomHeight[1];var j=f+Math.floor(ROT.RNG.getUniform()*(h-f+1));var c=e-Math.floor(ROT.RNG.getUniform()*b);var i=d-Math.floor(ROT.RNG.getUniform()*j);var a=c+b-1;var g=i+j-1;return new this(c,i,a,g)};ROT.Map.Feature.Room.createRandom=function(f,k,m){var e=m.roomWidth[0];var i=m.roomWidth[1];var c=e+Math.floor(ROT.RNG.getUniform()*(i-e+1));var e=m.roomHeight[0];var i=m.roomHeight[1];var l=e+Math.floor(ROT.RNG.getUniform()*(i-e+1));var d=f-c-1;var h=k-l-1;var b=1+Math.floor(ROT.RNG.getUniform()*d);var j=1+Math.floor(ROT.RNG.getUniform()*h);var a=b+c-1;var g=j+l-1;return new this(b,j,a,g)};ROT.Map.Feature.Room.prototype.addDoor=function(a,b){this._doors[a+","+b]=1};ROT.Map.Feature.Room.prototype.getDoors=function(c){for(var a in this._doors){var b=a.split(",");c(parseInt(b[0]),parseInt(b[1]))}};ROT.Map.Feature.Room.prototype.clearDoors=function(){this._doors={};return this};ROT.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)};ROT.Map.Feature.Room.prototype.isValid=function(b,e){var g=this._x1-1;var d=this._x2+1;var f=this._y1-1;var c=this._y2+1;for(var a=g;a<=d;a++){for(var h=f;h<=c;h++){if(a==g||a==d||h==f||h==c){if(!b(a,h)){return false}}else{if(!e(a,h)){return false}}}}return true};ROT.Map.Feature.Room.prototype.create=function(e){var g=this._x1-1;var c=this._x2+1;var f=this._y1-1;var b=this._y2+1;var d=0;for(var a=g;a<=c;a++){for(var h=f;h<=b;h++){if(a+","+h in this._doors){d=2}else{if(a==g||a==c||h==f||h==b){d=1}else{d=0}}e(a,h,d)}}};ROT.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]};ROT.Map.Feature.Room.prototype.getLeft=function(){return this._x1};ROT.Map.Feature.Room.prototype.getRight=function(){return this._x2};ROT.Map.Feature.Room.prototype.getTop=function(){return this._y1};ROT.Map.Feature.Room.prototype.getBottom=function(){return this._y2};ROT.Map.Feature.Corridor=function(b,a,d,c){this._startX=b;this._startY=a;this._endX=d;this._endY=c;this._endsWithAWall=true};ROT.Map.Feature.Corridor.extend(ROT.Map.Feature);ROT.Map.Feature.Corridor.createRandomAt=function(b,h,d,c,e){var f=e.corridorLength[0];var a=e.corridorLength[1];var g=f+Math.floor(ROT.RNG.getUniform()*(a-f+1));return new this(b,h,b+d*g,h+c*g)};ROT.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)};ROT.Map.Feature.Corridor.prototype.isValid=function(a,o){var m=this._startX;var j=this._startY;var p=this._endX-m;var n=this._endY-j;var b=1+Math.max(Math.abs(p),Math.abs(n));if(p){p=p/Math.abs(p)}if(n){n=n/Math.abs(n)}var e=n;var d=-p;var h=true;for(var c=0;c<b;c++){var l=m+c*p;var g=j+c*n;if(!o(l,g)){h=false}if(!a(l+e,g+d)){h=false}if(!a(l-e,g-d)){h=false}if(!h){b=c;this._endX=l-p;this._endY=g-n;break}}if(b==0){return false}if(b==1&&a(this._endX+p,this._endY+n)){return false}var k=!a(this._endX+p+e,this._endY+n+d);var f=!a(this._endX+p-e,this._endY+n-d);this._endsWithAWall=a(this._endX+p,this._endY+n);if((k||f)&&this._endsWithAWall){return false}return true};ROT.Map.Feature.Corridor.prototype.create=function(a){var j=this._startX;var g=this._startY;var l=this._endX-j;var k=this._endY-g;var b=1+Math.max(Math.abs(l),Math.abs(k));if(l){l=l/Math.abs(l)}if(k){k=k/Math.abs(k)}var e=k;var d=-l;for(var c=0;c<b;c++){var h=j+c*l;var f=g+c*k;a(h,f,0)}return true};ROT.Map.Feature.Corridor.prototype.createPriorityWalls=function(c){if(!this._endsWithAWall){return}var g=this._startX;var e=this._startY;var d=this._endX-g;var b=this._endY-e;if(d){d=d/Math.abs(d)}if(b){b=b/Math.abs(b)}var a=b;var f=-d;c(this._endX+d,this._endY+b);c(this._endX+a,this._endY+f);c(this._endX-a,this._endY-f)};ROT.Noise=function(){};ROT.Noise.prototype.get=function(a,b){};ROT.Noise.Simplex=function(a){ROT.Noise.call(this);this._F2=0.5*(Math.sqrt(3)-1);this._G2=(3-Math.sqrt(3))/6;this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];var b=[];var d=a||256;for(var c=0;c<d;c++){b.push(c)}b=b.randomize();this._perms=[];this._indexes=[];for(var c=0;c<2*d;c++){this._perms.push(b[c%d]);this._indexes.push(this._perms[c]%this._gradients.length)}};ROT.Noise.Simplex.extend(ROT.Noise);ROT.Noise.Simplex.prototype.get=function(B,l){var G=this._perms;var h=this._indexes;var k=G.length/2;var b=this._G2;var p=0,n=0,m=0,E;var w=(B+l)*this._F2;var z=Math.floor(B+w);var y=Math.floor(l+w);var v=(z+y)*b;var H=z-v;var f=y-v;var F=B-H;var e=l-f;var x,a;if(F>e){x=1;a=0}else{x=0;a=1}var C=F-x+b;var d=e-a+b;var A=F-1+2*b;var c=e-1+2*b;var u=z.mod(k);var D=y.mod(k);var r=0.5-F*F-e*e;if(r>=0){r*=r;E=h[u+G[D]];var g=this._gradients[E];p=r*r*(g[0]*F+g[1]*e)}var q=0.5-C*C-d*d;if(q>=0){q*=q;E=h[u+x+G[D+a]];var g=this._gradients[E];n=q*q*(g[0]*C+g[1]*d)}var o=0.5-A*A-c*c;if(o>=0){o*=o;E=h[u+1+G[D+1]];var g=this._gradients[E];m=o*o*(g[0]*A+g[1]*c)}return 70*(p+n+m)};ROT.FOV=function(b,a){this._lightPasses=b;this._options={topology:8};for(var c in a){this._options[c]=a[c]}};ROT.FOV.prototype.compute=function(a,d,b,c){};ROT.FOV.prototype._getCircle=function(e,d,a){var m=[];var b,c,h;switch(this._options.topology){case 4:c=1;h=[0,1];b=[ROT.DIRS[8][7],ROT.DIRS[8][1],ROT.DIRS[8][3],ROT.DIRS[8][5]];break;case 6:b=ROT.DIRS[6];c=1;h=[-1,1];break;case 8:b=ROT.DIRS[4];c=2;h=[-1,1];break}var l=e+h[0]*a;var k=d+h[1]*a;for(var g=0;g<b.length;g++){for(var f=0;f<a*c;f++){m.push([l,k]);l+=b[g][0];k+=b[g][1]}}return m};ROT.FOV.DiscreteShadowcasting=function(b,a){ROT.FOV.call(this,b,a)};ROT.FOV.DiscreteShadowcasting.extend(ROT.FOV);ROT.FOV.DiscreteShadowcasting.prototype.compute=function(o,n,m,p){var c=this._coords;var d=this._map;p(o,n,0);if(!this._lightPasses(o,n)){return}var k=[];var f,e,j,h,b;for(var a=1;a<=m;a++){var q=this._getCircle(o,n,a);var g=360/q.length;for(var l=0;l<q.length;l++){j=q[l][0];h=q[l][1];f=g*(l-0.5);e=f+g;b=!this._lightPasses(j,h);if(this._visibleCoords(Math.floor(f),Math.ceil(e),b,k)){p(j,h,a,1)}if(k.length==2&&k[0]==0&&k[1]==360){return}}}};ROT.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(a,h,f,b){if(a<0){var g=arguments.callee(0,h,f,b);var e=arguments.callee(360+a,360,f,b);return g||e}var c=0;while(c<b.length&&b[c]<a){c++}if(c==b.length){if(f){b.push(a,h)}return true}var d=0;if(c%2){while(c<b.length&&b[c]<h){c++;d++}if(d==0){return false}if(f){if(d%2){b.splice(c-d,d,h)}else{b.splice(c-d,d)}}return true}else{while(c<b.length&&b[c]<h){c++;d++}if(a==b[c-d]&&d==1){return false}if(f){if(d%2){b.splice(c-d,d,a)}else{b.splice(c-d,d,a,h)}}return true}};ROT.FOV.PreciseShadowcasting=function(b,a){ROT.FOV.call(this,b,a)};ROT.FOV.PreciseShadowcasting.extend(ROT.FOV);ROT.FOV.PreciseShadowcasting.prototype.compute=function(m,l,k,n){n(m,l,0,1);if(!this._lightPasses(m,l)){return}var c=[];var h,g,b,f,e,d;for(var a=1;a<=k;a++){var p=this._getCircle(m,l,a);var o=p.length;for(var j=0;j<o;j++){h=p[j][0];g=p[j][1];f=[j?2*j-1:2*o-1,2*o];e=[2*j+1,2*o];b=!this._lightPasses(h,g);d=this._checkVisibility(f,e,b,c);if(d){n(h,g,a,d)}if(c.length==2&&c[0][0]==0&&c[1][0]==c[1][1]){return}}}};ROT.FOV.PreciseShadowcasting.prototype._checkVisibility=function(c,b,r,d){if(c[0]>b[0]){var f=this._checkVisibility(c,[c[1],c[1]],r,d);var e=this._checkVisibility([0,1],b,r,d);return(f+e)/2}var l=0,q=false;while(l<d.length){var a=d[l];var p=a[0]*c[1]-c[0]*a[1];if(p>=0){if(p==0&&!(l%2)){q=true}break}l++}var k=d.length,o=false;while(k--){var a=d[k];var p=b[0]*a[1]-a[0]*b[1];if(p>=0){if(p==0&&(k%2)){o=true}break}}var h=true;if(l==k&&(q||o)){h=false}else{if(q&&o&&l+1==k&&(k%2)){h=false}else{if(l>k&&(l%2)){h=false}}}if(!h){return 0}var g,m;var s=k-l+1;if(s%2){if(l%2){var m=d[l];g=(b[0]*m[1]-m[0]*b[1])/(m[1]*b[1]);if(r){d.splice(l,s,b)}}else{var m=d[k];g=(m[0]*c[1]-c[0]*m[1])/(c[1]*m[1]);if(r){d.splice(l,s,c)}}}else{if(l%2){var j=d[l];var i=d[k];g=(i[0]*j[1]-j[0]*i[1])/(j[1]*i[1]);if(r){d.splice(l,s)}}else{if(r){d.splice(l,s,c,b)}return 1}}var n=(b[0]*c[1]-c[0]*b[1])/(c[1]*b[1]);return g/n};ROT.Color={fromString:function(e){var c,d;if(e in this._cache){c=this._cache[e]}else{if(e.charAt(0)=="#"){var a=e.match(/[0-9a-f]/gi).map(function(f){return parseInt(f,16)});if(a.length==3){c=a.map(function(f){return f*17})}else{for(var b=0;b<3;b++){a[b+1]+=16*a[b];a.splice(b,1)}c=a}}else{if(d=e.match(/rgb\(([0-9, ]+)\)/i)){c=d[1].split(/\s*,\s*/).map(function(f){return parseInt(f)})}else{c=[0,0,0]}}this._cache[e]=c}return c.slice()},add:function(c,b){var a=c.slice();for(var e=0;e<3;e++){for(var d=1;d<arguments.length;d++){a[e]+=arguments[d][e]}}return a},add_:function(b,a){for(var d=0;d<3;d++){for(var c=1;c<arguments.length;c++){b[d]+=arguments[c][d]}}return b},multiply:function(c,b){var a=c.slice();for(var e=0;e<3;e++){for(var d=1;d<arguments.length;d++){a[e]*=arguments[d][e]/255}a[e]=Math.round(a[e])}return a},multiply_:function(b,a){for(var d=0;d<3;d++){for(var c=1;c<arguments.length;c++){b[d]*=arguments[c][d]/255}b[d]=Math.round(b[d])}return b},interpolate:function(c,b,e){if(arguments.length<3){e=0.5}var a=c.slice();for(var d=0;d<3;d++){a[d]=Math.round(a[d]+e*(b[d]-c[d]))}return a},interpolateHSL:function(b,a,d){if(arguments.length<3){d=0.5}var f=this.rgb2hsl(b);var e=this.rgb2hsl(a);for(var c=0;c<3;c++){f[c]+=d*(e[c]-f[c])}return this.hsl2rgb(f)},randomize:function(b,d){if(!(d instanceof Array)){d=ROT.RNG.getNormal(0,d)}var a=b.slice();for(var c=0;c<3;c++){a[c]+=(d instanceof Array?Math.round(ROT.RNG.getNormal(0,d[c])):d)}return a},rgb2hsl:function(e){var a=e[0]/255;var j=e[1]/255;var m=e[2]/255;var n=Math.max(a,j,m),f=Math.min(a,j,m);var i,o,c=(n+f)/2;if(n==f){i=o=0}else{var k=n-f;o=(c>0.5?k/(2-n-f):k/(n+f));switch(n){case a:i=(j-m)/k+(j<m?6:0);break;case j:i=(m-a)/k+2;break;case m:i=(a-j)/k+4;break}i/=6}return[i,o,c]},hsl2rgb:function(h){var f=h[2];if(h[1]==0){f*=255;return[f,f,f]}else{function e(l,g,b){if(b<0){b+=1}if(b>1){b-=1}if(b<1/6){return l+(g-l)*6*b}if(b<1/2){return g}if(b<2/3){return l+(g-l)*(2/3-b)*6}return l}var k=h[1];var c=(f<0.5?f*(1+k):f+k-f*k);var d=2*f-c;var a=e(d,c,h[0]+1/3);var i=e(d,c,h[0]);var j=e(d,c,h[0]-1/3);return[Math.round(a*255),Math.round(i*255),Math.round(j*255)]}},toRGB:function(a){return"rgb("+this._clamp(a[0])+","+this._clamp(a[1])+","+this._clamp(a[2])+")"},toHex:function(a){var c=[];for(var b=0;b<3;b++){c.push(this._clamp(a[b]).toString(16).lpad("0",2))}return"#"+c.join("")},_clamp:function(a){if(a<0){return 0}else{if(a>255){return 255}else{return a}}},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}};ROT.Lighting=function(b,a){this._reflectivityCallback=b;this._options={passes:1,emissionThreshold:100,range:10};this._fov=null;this._lights={};this._reflectivityCache={};this._fovCache={};this.setOptions(a)};ROT.Lighting.prototype.setOptions=function(a){for(var b in a){this._options[b]=a[b]}if(a.range){this.reset()}return this};ROT.Lighting.prototype.setFOV=function(a){this._fov=a;this._fovCache={};return this};ROT.Lighting.prototype.setLight=function(a,d,b){var c=a+","+d;if(b){this._lights[c]=(typeof(b)=="string"?ROT.Color.fromString(b):b)}else{delete this._lights[c]}return this};ROT.Lighting.prototype.reset=function(){this._reflectivityCache={};this._fovCache={};return this};ROT.Lighting.prototype.compute=function(j){var d={};var e={};var k={};for(var l in this._lights){var b=this._lights[l];if(!(l in e)){e[l]=[0,0,0]}ROT.Color.add_(e[l],b)}for(var c=0;c<this._options.passes;c++){this._emitLight(e,k,d);if(c+1==this._options.passes){continue}e=this._computeEmitters(k,d)}for(var f in k){var a=f.split(",");var h=parseInt(a[0]);var g=parseInt(a[1]);j(h,g,k[f])}return this};ROT.Lighting.prototype._emitLight=function(c,f,b){for(var d in c){var e=d.split(",");var a=parseInt(e[0]);var g=parseInt(e[1]);this._emitLightFromCell(a,g,c[d],f);b[d]=1}return this};ROT.Lighting.prototype._computeEmitters=function(l,h){var n={};for(var m in l){if(m in h){continue}var c=l[m];if(m in this._reflectivityCache){var f=this._reflectivityCache[m]}else{var d=m.split(",");var k=parseInt(d[0]);var j=parseInt(d[1]);var f=this._reflectivityCallback(k,j);this._reflectivityCache[m]=f}if(f==0){continue}var g=[];var b=0;for(var e=0;e<3;e++){var a=Math.round(c[e]*f);g[e]=a;b+=a}if(b>this._options.emissionThreshold){n[m]=g}}return n};ROT.Lighting.prototype._emitLightFromCell=function(g,e,b,h){var j=g+","+e;if(j in this._fovCache){var d=this._fovCache[j]}else{var d=this._updateFOV(g,e)}for(var f in d){var a=d[f];if(f in h){var k=h[f]}else{var k=[0,0,0];h[f]=k}for(var c=0;c<3;c++){k[c]+=Math.round(b[c]*a)}}return this};ROT.Lighting.prototype._updateFOV=function(b,f){var e=b+","+f;var d={};this._fovCache[e]=d;var c=this._options.range;var a=function(g,l,i,j){var h=g+","+l;var k=j*(1-i/c);if(k==0){return}d[h]=k};this._fov.compute(b,f,c,a.bind(this));return d};ROT.Path=function(e,d,b,a){this._toX=e;this._toY=d;this._fromX=null;this._fromY=null;this._passableCallback=b;this._options={topology:8};for(var c in a){this._options[c]=a[c]}this._dirs=ROT.DIRS[this._options.topology]};ROT.Path.prototype.compute=function(c,a,b){};ROT.Path.prototype._getNeighbors=function(c,g){var b=[];for(var e=0;e<this._dirs.length;e++){var d=this._dirs[e];var a=c+d[0];var f=g+d[1];if(!this._passableCallback(a,f)){continue}b.push([a,f])}return b};ROT.Path.Dijkstra=function(d,c,b,a){ROT.Path.call(this,d,c,b,a);this._computed={};this._todo=[];this._add(d,c,null)};ROT.Path.Dijkstra.extend(ROT.Path);ROT.Path.Dijkstra.prototype.compute=function(e,c,d){var a=e+","+c;if(!(a in this._computed)){this._compute(e,c)}if(!(a in this._computed)){return}var b=this._computed[a];while(b){d(b.x,b.y);b=b.prev}};ROT.Path.Dijkstra.prototype._compute=function(e,d){while(this._todo.length){var h=this._todo.shift();if(h.x==e&&h.y==d){return}var j=this._getNeighbors(h.x,h.y);for(var b=0;b<j.length;b++){var g=j[b];var f=g[0];var c=g[1];var a=f+","+c;if(a in this._computed){continue}this._add(f,c,h)}}};ROT.Path.Dijkstra.prototype._add=function(a,d,b){var c={x:a,y:d,prev:b};this._computed[a+","+d]=c;this._todo.push(c)};ROT.Path.AStar=function(d,c,b,a){ROT.Path.call(this,d,c,b,a);this._todo=[];this._done={};this._fromX=null;this._fromY=null};ROT.Path.AStar.extend(ROT.Path);ROT.Path.AStar.prototype.compute=function(e,d,g){this._todo=[];this._done={};this._fromX=e;this._fromY=d;this._add(this._toX,this._toY,null);while(this._todo.length){var j=this._todo.shift();if(j.x==e&&j.y==d){break}var k=this._getNeighbors(j.x,j.y);for(var b=0;b<k.length;b++){var h=k[b];var f=h[0];var c=h[1];var a=f+","+c;if(a in this._done){continue}this._add(f,c,j)}}var j=this._done[e+","+d];if(!j){return}while(j){g(j.x,j.y);j=j.prev}};ROT.Path.AStar.prototype._add=function(a,h,d){var g={x:a,y:h,prev:d,g:(d?d.g+1:0),h:this._distance(a,h)};this._done[a+","+h]=g;var e=g.g+g.h;for(var b=0;b<this._todo.length;b++){var c=this._todo[b];if(e<c.g+c.h){this._todo.splice(b,0,g);return}}this._todo.push(g)};ROT.Path.AStar.prototype._distance=function(a,d){switch(this._options.topology){case 4:return(Math.abs(a-this._fromX)+Math.abs(d-this._fromY));break;case 6:var c=Math.abs(a-this._fromX);var b=Math.abs(d-this._fromY);return b+Math.max(0,(c-b)/2);break;case 8:return Math.max(Math.abs(a-this._fromX),Math.abs(d-this._fromY));break}};